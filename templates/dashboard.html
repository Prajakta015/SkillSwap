<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Studio | Skill Swap Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;800&display=swap" rel="stylesheet">
    <style>
    :root {
        --primary: #7d2ae8;
        --secondary: #00d2ff;
        --bg: #0f172a;
        --glass: rgba(255, 255, 255, 0.03);
        --border: rgba(255, 255, 255, 0.1);
        --success: #00ff88;
        --error: #ff4444;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
        font-family: 'Plus Jakarta Sans', sans-serif; 
        background: var(--bg); 
        color: white;
        overflow-x: hidden; 
        display: flex;
    }

    /* BACKGROUND ANIMATION */
    .blob {
        position: absolute; width: 600px; height: 600px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        filter: blur(120px); border-radius: 50%; z-index: -1; opacity: 0.15;
        animation: move 25s infinite alternate;
    }

    /* SIDE NAV - ENHANCED GLASS */
    nav {
        width: 100px; height: 100vh;
        background: rgba(255, 255, 255, 0.02);
        backdrop-filter: blur(20px);
        border-right: 1px solid var(--border);
        display: flex; flex-direction: column; align-items: center;
        padding: 40px 0; gap: 30px; z-index: 10;
        position: fixed;
    }

    .nav-icon {
        width: 54px; height: 54px; border-radius: 16px;
        background: var(--glass); display: flex; align-items: center;
        justify-content: center; cursor: pointer; 
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        border: 1px solid var(--border); font-size: 18px; font-weight: 800;
        text-decoration: none; position: relative; color: rgba(255, 255, 255, 0.6);
    }

    .nav-icon:hover, .nav-icon.active { 
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        transform: scale(1.1) translateX(5px); 
        box-shadow: 0 0 25px rgba(125, 42, 232, 0.5); 
        border-color: rgba(255, 255, 255, 0.3);
        color: white;
    }

    /* MAIN WORKSPACE */
    .workspace { flex: 1; margin-left: 100px; padding: 60px; min-height: 100vh; position: relative; }
    
    .header-flex { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 50px; }
    .user-greet h1 { font-size: 42px; font-weight: 800; letter-spacing: -1px; display: flex; align-items: center; gap: 15px; }
    
    .v-badge {
        background: var(--secondary); color: var(--bg);
        width: 28px; height: 28px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 14px; font-weight: 900; box-shadow: 0 0 15px var(--secondary);
    }

    .credit-badge {
        background: var(--glass); padding: 12px 25px; border-radius: 50px;
        border: 1px solid var(--border); display: flex; align-items: center; gap: 12px;
        backdrop-filter: blur(10px);
    }

    /* PANELS & CARDS */
    .status-panel {
        margin-bottom: 50px; padding: 2px; border-radius: 25px;
        background: linear-gradient(90deg, var(--primary), var(--secondary), var(--primary));
        background-size: 200% auto; animation: shine 4s linear infinite;
    }
    .inner-panel {
        background: var(--bg); padding: 35px; border-radius: 23px;
        display: flex; justify-content: space-between; align-items: center;
    }

    .bounty-card {
        background: var(--glass); border: 1px solid var(--border);
        padding: 25px; border-radius: 20px; transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    }
    .bounty-card:hover {
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(0, 210, 255, 0.3);
        transform: translateY(-5px);
    }

    /* SEARCH SECTION */
    .search-section { margin-top: 40px; }
    .search-box {
        background: var(--glass); border: 1px solid var(--border);
        border-radius: 24px; display: flex; padding: 10px; transition: 0.4s;
        backdrop-filter: blur(10px);
    }
    .search-box:focus-within { border-color: var(--secondary); box-shadow: 0 0 40px rgba(0, 210, 255, 0.15); }
    .search-box input { flex: 1; background: transparent; border: none; padding: 15px 25px; color: white; outline: none; font-size: 17px; }
    
    /* BUTTONS */
    .btn-action {
        padding: 12px 24px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.05);
        color: white;
        font-weight: 700;
        font-size: 13px;
        letter-spacing: 0.5px;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(5px);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
    }

    .btn-action:hover {
        background: var(--primary);
        border-color: var(--secondary);
        box-shadow: 0 0 20px rgba(125, 42, 232, 0.4);
        transform: translateY(-3px) scale(1.02);
        color: white;
    }

    .btn-accept {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border: none;
        box-shadow: 0 4px 15px rgba(0, 210, 255, 0.2);
    }

    .btn-accept:hover {
        box-shadow: 0 8px 25px rgba(0, 210, 255, 0.4);
    }

    .magic-card {
        background: rgba(255, 255, 255, 0.04); border-left: 5px solid var(--secondary);
        padding: 25px; border-radius: 20px; margin-top: 20px;
        display: flex; justify-content: space-between; align-items: center;
        animation: slideUp 0.5s ease-out forwards;
    }

    /* ANIMATIONS */
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    @keyframes shine { to { background-position: 200% center; } }
    @keyframes move { from { transform: translate(-10%, -10%); } to { transform: translate(20%, 15%); } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

</style>
</head>
<body>
    <div class="blob"></div>

    <nav>
        <a href="/dashboard" class="nav-icon active" title="Dashboard">DB</a>
        <a href="/connections" class="nav-icon" title="Connection Hub">
            CN
            <span id="notification-dot" style="display:none; position: absolute; top: 0; right: 0; width: 12px; height: 12px; background: var(--secondary); border-radius: 50%; border: 2px solid var(--bg);"></span>
        </a>
        <a href="/bounties" class="nav-icon" title="Bounty Board">BN</a>
        <a href="/my_projects" class="nav-icon" title="My Projects">MP</a>
        <a href="/profile" class="nav-icon" title="Profile">PR</a>
        <a href="/logout" class="nav-icon" title="Logout" style="margin-top: auto; color: #ff4444;">ðŸšª</a>
    </nav>

    <div class="workspace">
        <div class="header-flex">
            <div class="user-greet">
                <p style="color: var(--secondary); font-weight: 700; text-transform: uppercase; letter-spacing: 2px; font-size: 12px; margin-bottom: 8px;">Studio Intelligence</p>
                <h1>
                    {{ greeting }}
                    {% if user.verified %}
                    <div class="v-badge" title="Verified Expert">âœ“</div>
                    {% endif %}
                </h1>
            </div>
            <div class="credit-badge">
                <div style="width: 10px; height: 10px; background: var(--success); border-radius: 50%; animation: pulse 2s infinite;"></div>
                <span style="font-weight: 800;">{{ user.credits }} CREDITS</span>
            </div>
        </div>

        <div class="status-panel">
            <div class="inner-panel">
                {% if not user.verified %}
                <div>
                    <h2 style="font-size: 22px; margin-bottom: 6px;">The Skill Lab is Open</h2>
                    <p style="opacity: 0.6; font-size: 14px;">Verify your mastery in <strong>{{ user.skill }}</strong> to unlock 10 bonus credits.</p>
                </div>
                <button class="btn-action" onclick="window.location.href='/onboarding'" style="background: var(--secondary); color: white;">Begin Proof</button>
                {% else %}
                <div>
                    <h2 style="font-size: 22px; margin-bottom: 6px; color: var(--success);">Expert Status Active</h2>
                    <p style="opacity: 0.8; font-size: 14px;">Your profile is prioritized in Magic Searches for {{ user.skill }}.</p>
                </div>
                <button class="btn-action" onclick="window.location.href='/my_projects'" style="background: var(--glass); color: white; border: 1px solid var(--border);">Manage Projects</button>
                {% endif %}
            </div>
        </div>

<div class="active-projects-preview" style="margin-bottom: 40px;">
    <h2 style="opacity: 0.8; font-weight: 600; margin-bottom: 20px;">Missions in Progress</h2>
    <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
        {% for project in user_projects if project.status == 'In Progress' %}
        <div class="magic-card" style="margin-top: 0; border-left: 5px solid var(--primary);">
            <div>
                <span style="font-size: 10px; font-weight: 800; color: var(--primary);">ACTIVE TASK</span>
                <h3 style="font-size: 16px;">{{ project.title }}</h3>
            </div>
            <button class="btn-action" onclick="window.location.href='/my_projects'">Go to Workspace</button>
        </div>
        {% endfor %}
    </div>
</div>

<div class="bounties-container" style="margin-bottom: 60px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h2 style="opacity: 0.8; font-weight: 600;">Active Bounties</h2>
        <span style="font-size: 12px; color: var(--secondary); cursor: pointer;" onclick="window.location.href='/bounties'">View All Bounties â†’</span>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
        {% for bounty in bounties %}
            <div style="background: var(--glass); border: 1px solid var(--border); padding: 25px; border-radius: 20px; transition: 0.3s; position: relative; overflow: hidden;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                    <span style="background: rgba(0, 210, 255, 0.1); color: var(--secondary); padding: 4px 12px; border-radius: 50px; font-size: 11px; font-weight: 800; text-transform: uppercase;">{{ bounty.status }}</span>
                    <span style="font-weight: 800; color: var(--success);">+{{ bounty.reward }}c</span>
                </div>
                <h3 style="font-size: 18px; margin-bottom: 8px;">{{ bounty.title }}</h3>
                <p style="font-size: 14px; opacity: 0.6; margin-bottom: 20px; min-height: 40px;">{{ bounty.description }}</p>
                
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 13px; opacity: 0.8;">By <strong>{{ bounty.owner_name }}</strong></span>
                    {% if bounty.owner_email != user.email %}
                    <button class="btn-action" onclick="window.location.href='/bounties'" style="background: var(--glass); border: 1px solid var(--secondary); color: var(--secondary);">Analyze Mission</button>
                    <span style="font-size: 11px; opacity: 0.4;">Your Post</span>
                    {% endif %}
                </div>
            </div>
        {% else %}
            <div style="grid-column: 1/-1; padding: 40px; text-align: center; background: var(--glass); border-radius: 20px; border: 1px dashed var(--border);">
                <p style="opacity: 0.5;">No active bounties in your sector. Be the first to post one!</p>
                <button onclick="window.location.href='/bounties'" style="margin-top: 15px; background: transparent; color: var(--secondary); border: 1px solid var(--secondary); padding: 8px 20px; border-radius: 10px; cursor: pointer;">Go to Bounty Board</button>
            </div>
        {% endfor %}
    </div>
</div>

<div class="search-section">
    <h2 style="margin-bottom: 20px; opacity: 0.8; font-weight: 600;">Magic Search</h2>
    <div class="search-box">
        <input type="text" id="magicInput" placeholder="I need someone to help me build a React app using Tailwind...">
        <button onclick="triggerMagicSearch()" id="magicBtn">âœ¨ Match Me</button>
    </div>
    <div id="magicResults"></div>
</div>

    <script>
        // 2. MAGIC SEARCH LOGIC
        async function triggerMagicSearch() {
            const input = document.getElementById('magicInput');
            const btn = document.getElementById('magicBtn');
            const container = document.getElementById('magicResults');
            if (!input.value) return;

            btn.innerText = "Searching AI..."; btn.disabled = true;
            container.innerHTML = "";
            const fd = new FormData(); fd.append('query', input.value);

            try {
                const res = await fetch('/magic_search', { method: 'POST', body: fd });
                const data = await res.json();
                if (data.status === 'success') {
                    const matches = JSON.parse(data.matches);
                    if(matches.length === 0) container.innerHTML = "<p style='margin-top:20px; opacity:0.5;'>No direct matches found. Try a broader search!</p>";
                    
                    matches.forEach(m => {
                        const div = document.createElement('div');
                        div.className = 'magic-card';
                        div.innerHTML = `
                            <div>
                                <strong style="color:var(--secondary);">${m.name}</strong> â€¢ <small>${m.skill}</small>
                                <p style="font-size:14px; margin-top:8px; opacity:0.8;">${m.reason}</p>
                            </div>
                            <button class="btn-action" onclick="sendSwapRequest('${m.email}', '${m.name}')">Ping</button>
                        `;
                        container.appendChild(div);
                    });
                }
            } catch (e) { console.error(e); } finally { btn.innerText = "âœ¨ Match Me"; btn.disabled = false; }
        }

        // 3. SEND REQUEST LOGIC
        async function sendSwapRequest(email, name) {
            const msg = prompt(`Send a message to ${name}:`, "I saw your profile and would love to swap skills!");
            if (!msg) return;

            const fd = new FormData();
            fd.append('receiver_email', email);
            fd.append('message', msg);

            const res = await fetch('/send_swap_request', { method: 'POST', body: fd });
            const data = await res.json();
            alert(data.message);
        }

        // 4. NOTIFICATION DOT (Check for incoming requests)
        async function checkDots() {
            try {
                const res = await fetch('/get_hub_data');
                const data = await res.json();
                document.getElementById('notification-dot').style.display = data.incoming.length > 0 ? 'block' : 'none';
            } catch (e) {}
        }
        setInterval(checkDots, 10000);
        checkDots();

        // 5. MOUSE ANIMATION
        document.querySelectorAll('.teacher-card').forEach(card => {
            card.addEventListener('mousemove', (e) => {
                const r = card.getBoundingClientRect();
                const x = e.clientX - r.left, y = e.clientY - r.top;
                card.style.transform = `rotateY(${(x - r.width/2)/12}deg) rotateX(${-(y - r.height/2)/12}deg) translateY(-12px)`;
            });
            card.addEventListener('mouseleave', () => card.style.transform = "none");
        });
    </script>
</body>
</html>